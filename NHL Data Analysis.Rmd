---
title: "NHL Hockey: ST 558 Project 1"
author: "Peter Lung"
date: "6/12/2021"
html_document: 
  toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
base_url <- "https://records.nhl.com/site/api"
library(httr)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(stringr)
library(kableExtra)
```


```{r attendance, include=FALSE}
att_url <- paste0(base_url, "/attendance")
get_att <- GET(att_url)
txt_att <- content(get_att, "text")
json_att <- fromJSON(txt_att, flatten = TRUE)
```

```{r teamtot, include=FALSE}
teamtot_url <- paste0(base_url, "/franchise-team-totals")
get_teamtot <- GET(teamtot_url)
txt_teamtot <- content(get_teamtot, "text")
json_teamtot <- fromJSON(txt_teamtot, flatten = TRUE)
```

# NHL Data Analysis 

## Goalie Records

Do teams keep under-performing goalies around for a long time? I was curious to see win percentage by number of games played. Of course, there could be a lot of things going on here, but I am interested in the lower-right quadrant of the scatterplot of win percentage and games played. Are there goalies who just have long losing careers? Maybe they are good, but they are just stuck on losing teams all of the time? Maybe they aren't good, and they contribute to losing records, but teams keep them around?

### Histograms

Before we jump into the analysis, let's do some data investigation. We will start with histograms of the variables we are interested in.

```{r goalierec1, echo = FALSE, warnings = FALSE, messages = FALSE}
#There are 38 team IDs
for (i in 1:38) {
  goalierec_url <- paste0(base_url, "/franchise-goalie-records?cayenneExp=franchiseId=",toString(i))
  get_goalierec <- GET(goalierec_url)
  txt_goalierec <- content(get_goalierec, "text", encoding = "UTF-8")
  json_goalierec <- fromJSON(txt_goalierec, flatten = TRUE)
  if (i == 1) {GoaliePull <- as.data.frame(json_goalierec)} else {GoaliePull <- rbind(GoaliePull, as.data.frame(json_goalierec))}
}

GoalieRecords <- GoaliePull %>% mutate(Win.Percentage = data.wins / data.gamesPlayed)

g1 <- ggplot(GoalieRecords, aes(x = Win.Percentage, , y = ..density..))
g1 + geom_histogram(color = "white", fill = "#666666", bins = 35) + geom_density(color = "blue") + labs(title = "Histogram for Goalie Win Percentage")

```

There are several players with a win percentage of 0% and a few with 100%. This is because many of these players have only played in a few games. I think it makes sense to filter out goalies who have played less than 20 games so that we have appropraite sample sizes. Removing those players and re-creating the histogram:

```{r goalierec2, echo = FALSE, warnings = FALSE, messages = FALSE}
GoalieRecords <- filter(GoalieRecords, data.gamesPlayed >=20)

g2 <- ggplot(GoalieRecords, aes(x = Win.Percentage, , y = ..density..))
g2 + geom_histogram(color = "white", fill = "#666666", bins = 35) + geom_density(color = "blue") + labs(title = "Histogram for Win Percentage (at least 20 games)")
```

Now that we have removed players with under 20 games, let's look at a histogram of games played:

```{r goalierec3, echo = FALSE, warnings = FALSE, messages = FALSE}
GoalieRecords <- filter(GoalieRecords, data.gamesPlayed >=20)

g3 <- ggplot(GoalieRecords, aes(x = data.gamesPlayed, , y = ..density..))
g3 + geom_histogram(color = "white", fill = "#666666", bins = 35) + geom_density(color = "blue") + labs(title = "Histogram for Games Played") + xlab("Games Played")
```

### Scatterplot

I am interested in statistics around goalie career losses and lowest winning percentages. Players can get stuck on losing teams even if they are very good (just ask Mike Trout). I want to see who these goalies might be in the NHL and just how badly their careers went.

We continue the analysis with a scatterplot of win percentage by games played.

```{r goalierec4, echo = FALSE, warnings = FALSE, messages = FALSE}
#Find out who had the most losses
MostLosses <- max(GoalieRecords$data.losses)
Loser <- filter(GoalieRecords, data.losses == MostLosses) %>% select(data.firstName, data.lastName, data.gamesPlayed)

#Lowest winning percentage in over 500 games
FrustratedPct <- min(filter(GoalieRecords, data.gamesPlayed > 500) %>% select(Win.Percentage))
Frustrated <- filter(GoalieRecords, data.gamesPlayed > 500) %>% filter(Win.Percentage == min(FrustratedPct))  %>% select(data.firstName, data.lastName, data.gamesPlayed)

# Lowest winning percentage in the sample set (get max games played if there's a tie)
LowestPct <- min(GoalieRecords$Win.Percentage)
Lowest <- filter(GoalieRecords, Win.Percentage == LowestPct)  %>% select(data.firstName, data.lastName, data.gamesPlayed) %>% filter(data.gamesPlayed == max(data.gamesPlayed))

GoalieRecords <- mutate(GoalieRecords, Who.Stands.Out = ifelse(Win.Percentage == LowestPct , paste0(data.firstName, " ", data.lastName), ifelse(Win.Percentage == FrustratedPct, paste0(data.firstName, " ", data.lastName), ifelse(data.losses == MostLosses, paste0(data.firstName, " ", data.lastName), "Everybody Else"))))



g4 <- ggplot(GoalieRecords, aes(x = data.gamesPlayed, y = Win.Percentage, color = Who.Stands.Out))
g4 + geom_point() + labs(title = "Goalie Win Percentage by Career Games Played") + xlab("Games Played") + ylab("Win Percentage") + scale_color_manual(values=c("grey60", "green3", "firebrick3", "darkorange2"))

BiggestLoser <- paste0("The goalie with the most losses is ", Loser[1,1]," " , Loser[1,2], " with ", toString(MostLosses), ".")

MostFrustrated <- paste0("The goalie with the lowest win percentage (over 500 games) is ", Frustrated[1,1]," ", Frustrated[1,2], " at ", toString(round(100 * FrustratedPct, 1)),"% in ", toString(Frustrated[1,3]), " games.")

LowestRate <- paste0("The goalie with the lowest win percentage in the whole sample is ", Lowest[1,1]," ", Lowest[1,2], " at ", toString(round(LowestPct, 1)), "% in ", toString(Lowest[1,3]), " games.")
```

Win percentage is defined as win (not ties) divided by total games. Total games include ties.

Well, it looks like if you are really a loser, they don't keep you in the goal for *that* many games. Three players stand out to me from the graph:

`r BiggestLoser`

`r MostFrustrated`

`r LowestRate`

Total losses are probably more related to longevity than an extended poor performance. Having a zero or near-zero win percentage in 40+ games seems to be quite an anomaly. Even highly likely events can have a non-zero probability of occurring.

### Most Goals Scored Against a Goalie in a Single Game

The data has an interesting statistic that might be worth looking at: most goals scored on a goalie in a single game. It would be unfair to judge a player's career by their worst game, but in the name of data analysis, let's see if there are any relationships there.

Keeping with the 20 game minimum, we'll start with a histogram:

```{r goalierec5, echo = FALSE, warnings = FALSE, messages = FALSE}
g5 <- ggplot(GoalieRecords, aes(x = data.mostGoalsAgainstOneGame, , y = ..density..))
g5 + geom_histogram(color = "white", fill = "#666666", bins = 35) + labs(title = "Histogram for Single Game Goals Scored Against") + xlab("Most Goals Scored Against in a Single Game")
```

It seems that there are very few where the number of goals is over 11 or under 5, so let's create a set of categorical variables that denote most goals scored against with categories "<=5", "6", "7",...,"10", "11+". 

```{r goalierec6, echo = FALSE, warnings = FALSE, messages = FALSE}
ScoredAgainst <- mutate(GoalieRecords, Most.Scored.Against = recode(data.mostGoalsAgainstOneGame,
                                                                    "1" = "<6",
                                                                    "2" = "<6",
                                                                    "3" = "<6",
                                                                    "4" = "<6",
                                                                    "5" = "<6",
                                                                    "6" = "6",
                                                                    "7" = "7",
                                                                    "8" = "8",
                                                                    "9" = "9",
                                                                    "10" = "10",
                                                                    .default = "11+"))

ScoredAgainst$Most.Scored.Against <- factor(ScoredAgainst$Most.Scored.Against, levels = c("<6", "6", "7", "8", "9", "10", "11+"))

df0 <- filter(ScoredAgainst, Most.Scored.Against == "<6")
Defense <- as.data.frame(t(round(summary(df0$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq)  %>% rename("<6" = "Freq")
df1 <- filter(ScoredAgainst, Most.Scored.Against == "6")
A <- as.data.frame(t(round(summary(df1$Win.Percentage),3) )) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("6" = "Freq")
df2 <- filter(ScoredAgainst, Most.Scored.Against == "7")
B <- as.data.frame(t(round(summary(df2$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("7" = "Freq")
df3 <- filter(ScoredAgainst, Most.Scored.Against == "8")
C <- as.data.frame(t(round(summary(df3$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("8" = "Freq")
df4 <- filter(ScoredAgainst, Most.Scored.Against == "9")
D <- as.data.frame(t(round(summary(df4$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("9" = "Freq")
df5 <- filter(ScoredAgainst, Most.Scored.Against == "10")
E <- as.data.frame(t(round(summary(df5$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("10" = "Freq")
df6 <- filter(ScoredAgainst, Most.Scored.Against == "11+")
F <- as.data.frame(t(round(summary(df6$Win.Percentage),3))) %>% rename(Stat = Var2) %>% select(Stat, Freq) %>% rename("11+" = "Freq")

Defense <- Defense %>% left_join(A, by = "Stat") %>% left_join(B, by = "Stat") %>% left_join(C, by = "Stat") %>% left_join(D, by = "Stat") %>% left_join(E, by = "Stat") %>% left_join(F, by = "Stat")
Defense <- Defense %>% rename(" " = "Stat")
sampsize <- as.data.frame(t(c("n", nrow(df0), nrow(df1), nrow(df2), nrow(df3), nrow(df4), nrow(df5), nrow(df6)))) %>% rename(" " = "V1", "<6" = "V2", "6" = "V3", "7" = "V4", "8" = "V5", "9" = "V6", "10" = "V7", "11+" = "V8")
Defense <- rbind(Defense, sampsize)
kable(Defense, caption = "Summaries Statistics for Win Percentage by Career Most Goals Scored Against", digits = 3) %>% kable_styling()




```

We can use boxplots to visually see the distribution of win percentage by each of these categories.

```{r goalierec7, echo = FALSE, warnings = FALSE, messages = FALSE}
g6 <- ggplot(ScoredAgainst, aes(x = Most.Scored.Against, y = Win.Percentage, color = Most.Scored.Against))
g6 + geom_boxplot(fill = "white", colour = "black") + labs(title = "Boxplots of Win Percentage by Most Goals Scored Against") + geom_point(position = "jitter") + geom_smooth(formula = (y ~ x), method = lm, se = FALSE, aes(group=1), color = "black")
```

Interestingly, it appears that goalies with larger max number of goals scored against them in a game are a little more likely to have lower career winning percentages.

## Player Names

Hockey is a sport that is very popular in North America, particularly Canada. The names of players is a topic that is interesting because it may differ significantly from the name distribution of the general population

```{r names1, echo = FALSE, warnings = FALSE, messages = FALSE}
#There are 38 team IDs
for (i in 1:38) {
  skaterrec_url <- paste0(base_url, "/franchise-skater-records?cayenneExp=franchiseId=",toString(i))
  get_skaterrec <- GET(skaterrec_url)
  txt_skaterrec <- content(get_skaterrec, "text", encoding = "UTF-8")
  json_skaterrec <- fromJSON(txt_skaterrec, flatten = TRUE)
  if (i == 1) {SkaterPull <- as.data.frame(json_skaterrec)} else {SkaterPull <- rbind(SkaterPull, as.data.frame(json_skaterrec))}
}

PlayerData <- rbind(select(GoaliePull, data.firstName, data.lastName), select(SkaterPull, data.firstName, data.lastName))

FirstNames1 <- count(PlayerData, data.firstName) %>% arrange(desc(n)) %>% head(10) %>% rename(First.Name = data.firstName)
kable(FirstNames1, caption = "10 Most Common First Names") %>% kable_styling()

```

The number of last names might be more interesting since that may reveal more information about nationality than first names.

```{r names2, echo = FALSE, warnings = FALSE, messages = FALSE}

LastNames1 <- count(PlayerData, data.lastName) %>% arrange(desc(n)) %>% head(10) %>% rename(Last.Name =data.lastName)
kable(LastNames1, caption = "10 Most Common Last Names") %>% kable_styling()

```

Let's put the top 40 first names and the top 40 last names into bar charts and see what the relative frequencies are. We will remove the remainder to make the charts visible.

```{r names3, echo = FALSE, warnings = FALSE, messages = FALSE}

FirstNames2 <- count(PlayerData, data.firstName) %>% arrange(desc(n)) %>% head(40)  %>% rename(First.Name = data.firstName) 
#%>% mutate(name=factor(name, levels=name))
LastNames2 <- count(PlayerData, data.lastName) %>% arrange(desc(n)) %>% head(40)  %>% rename(Last.Name =data.lastName)

g7 <- ggplot(FirstNames2, aes(x = reorder(First.Name, desc(n))))
g7 + geom_bar(aes(weight = n), color = "white", fill = "darkolivegreen") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Top 40 First Names") + ylab("Count")

g8 <- ggplot(LastNames2, aes(x = reorder(Last.Name, desc(n))))
g8 + geom_bar(aes(weight = n), color = "white", fill = "darkolivegreen") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Top 40 Last Names") + ylab("Count")
```

## Bonus: Team Reg. Season Win % by Playoff Outcome

This is just because I was curious and wanted to explore more of the data. The endpoint wasn't in the list, but I found it in the API documentation and it had interesting data.

This is a series of boxplots showing the distribution of win percentages by the furthest point a team got in the playoffs. I would have expected it to be increasing monotonically, but playoff series being what they are, it flattens out (declines maybe?) after the first second because regular season success can be undone by small sample playoff randomness! I guess the *best* team doesn't always win the championship.

```{r teamseas, echo = FALSE, warnings = FALSE, messages = FALSE}
#There are 38 team IDs
for (i in 1:38) {
  teamseas_url <- paste0(base_url, "/franchise-season-results?cayenneExp=franchiseId=",toString(i),"&sort=seasonId&dir=DESC")
  get_teamseas <- GET(teamseas_url)
  txt_teamseas <- content(get_teamseas, "text", encoding = "UTF-8")
  json_teamseas <- fromJSON(txt_teamseas, flatten = TRUE)
  if (i == 1) {TeamData <- as.data.frame(json_teamseas)} else {TeamData <- rbind(TeamData, as.data.frame(json_teamseas))}
}
TeamData <- TeamData %>% mutate(Playoff.Series = ifelse(is.na(data.seriesTitle), "No Playoffs", data.seriesTitle))
TeamData$Playoff.Series <- factor(TeamData$Playoff.Series, levels = c("No Playoffs", "Stanley Cup Qualifiers", "1st Round", "2nd Round", "Conference Finals", "Stanley Cup Final"))
#NHL Final and Semifinal occurred only in one season
RegSeason <- TeamData %>% mutate(Win.Percentage = data.wins / data.gamesPlayed) %>% filter(data.gamesPlayed > 30, data.seasonId >= 20132014)
Playoffs <- TeamData %>% mutate(Win.Percentage = data.wins / data.gamesPlayed) %>% filter(data.gamesPlayed <= 30)


g9 <- ggplot(RegSeason, aes(x = Playoff.Series, y = Win.Percentage, color = Playoff.Series))
g9 + geom_boxplot(fill = "white", colour = "black") + geom_point(position = "jitter") + labs(title = "Win Percentage by Playoff Outcome, 2014 - Present") + scale_x_discrete(labels = function(Playoff.Series) str_wrap(Playoff.Series, width = 10))
```









